<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Empresas - Sistema Studio 57</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" xintegrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/global.css"> <!-- LINK PARA CSS GLOBAL -->

    <style>
        /* Estilos ESPECÍFICOS DO CADASTRO DE EMPRESA que NÃO estão no global.css */
        /* Mantendo apenas estilos únicos, se houver. */
        /* Por exemplo, se houver uma tabela de lista de empresas nesta página, seus estilos específicos. */
    </style>
</head>
<body>
    <!-- HEADER SERÁ CARREGADO AQUI VIA JS -->
    <div id="header-placeholder"></div>

    <div class="page-wrapper">
        <!-- SIDEBAR SERÁ CARREGADA AQUI VIA JS -->
        <div id="sidebar-placeholder"></div>

        <main class="main-content" id="main-content-area">
            <div id="feedback" class="hidden"></div>

            <form id="cadastro-empresa-form">
                <section class="section">
                    <h2>Dados da Empresa</h2>
                    <div class="form-grid">
                        <div class="grid-col-span-2 form-group"> <label for="razao-social" class="required">Razão Social:</label> <input type="text" id="razao-social" name="razao_social" required> </div>
                        <div class="form-group"> <label for="cnpj" class="required">CNPJ:</label> <input type="text" id="cnpj" name="cnpj" placeholder="00.000.000/0000-00" required maxlength="18"> </div>
                        <div class="form-group"> <label for="nome-fantasia">Nome Fantasia:</label> <input type="text" id="nome-fantasia" name="nome_fantasia"> </div>
                        <div class="form-group"> <label for="inscricao-estadual">Inscrição Estadual:</label> <input type="text" id="inscricao-estadual" name="inscricao_estadual"> </div>
                        <div class="form-group"> <label for="inscricao-municipal">Inscrição Municipal:</label> <input type="text" id="inscricao-municipal" name="inscricao_municipal"> </div>
                        <div class="form-group"> <label for="telefone">Telefone:</label> <input type="tel" id="telefone" name="telefone" placeholder="(00) 00000-0000"> </div>
                        <div class="form-group"> <label for="email">Email:</label> <input type="email" id="email" name="email"> </div>
                        <div class="grid-col-span-2 form-group"> <label for="responsavel-legal">Responsável Legal:</label> <input type="text" id="responsavel-legal" name="responsavel_legal"> </div>
                    </div>
                </section>

                <section class="section">
                    <h2>Endereço da Empresa</h2>
                    <div class="form-grid address-grid">
                        <div class="cep-container grid-col-span-2 form-group">
                            <div> <label for="cep" class="required">CEP:</label> <input type="text" id="cep" name="cep" placeholder="00000-000" required maxlength="9"> <span id="cep-status"></span> </div>
                            <button type="button" id="buscar-cep-btn" class="btn btn-info"><i class="fas fa-search"></i> Buscar</button>
                        </div>
                        <div class="grid-col-span-2 form-group"> <label for="logradouro" class="required">Logradouro (Rua/Av.):</label> <input type="text" id="logradouro" name="address_street" required> </div>
                        <div class="form-group"> <label for="numero" class="required">Número:</label> <input type="text" id="numero" name="address_number" required> </div>
                        <div class="form-group"> <label for="complemento">Complemento:</label> <input type="text" id="complemento" name="address_complement" placeholder="Apto, Bloco, etc."> </div>
                        <div class="form-group"> <label for="bairro" class="required">Bairro:</label> <input type="text" id="bairro" name="neighborhood" required> </div>
                        <div class="form-group"> <label for="cidade" class="required">Cidade:</label> <input type="text" id="cidade" name="city" required> </div>
                        <div class="form-group"> <label for="estado" class="required">Estado (UF):</label> <input type="text" id="estado" name="state" required maxlength="2"> </div>
                    </div>
                </section>

                <div class="main-actions">
                    <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Salvar Empresa</button>
                    <button type="reset" class="btn btn-secondary"><i class="fas fa-undo"></i> Limpar Formulário</button>
                </div>
            </form>

            <footer class="legal-footer">
                <p> © 2025 Studio 57 Arquitetura e Incorporação - CNPJ: 41.464.589/0001-66. Todos os direitos reservados. </p>
            </footer>
        </main>
    </div>
    <script src="js/common_ui.js"></script> <!-- LINK PARA JS COMUM -->
    <script>
        // --- Seletores Globais (adaptados para common_ui.js) ---
        const feedbackDiv = document.getElementById('feedback'); // O elemento #feedback global

        const cadastroEmpresaForm = document.getElementById('cadastro-empresa-form');

        const cnpjInput = document.getElementById('cnpj');
        const razaoSocialInput = document.getElementById('razao-social');

        const cepInput = document.getElementById('cep');
        const buscarCepBtn = document.getElementById('buscar-cep-btn');
        const logradouroInput = document.getElementById('logradouro');
        const numeroInput = document.getElementById('numero');
        const complementoInput = document.getElementById('complemento');
        const bairroInput = document.getElementById('bairro');
        const cidadeInput = document.getElementById('cidade');
        const estadoInput = document.getElementById('estado');
        const cepStatusSpan = document.getElementById('cep-status');

        let cepTimeout = null;
        let currentCompanyId = null; // Para modo de edição

        // --- Funções Auxiliares (adaptadas para common_ui.js) ---
        // updateDateTime, showFeedback, apiFetch agora vêm de common_ui.js (window.commonUi)

        function showFeedback(message, type = 'info', duration = 5000) {
            if (window.commonUi && window.commonUi.showFeedback) {
                window.commonUi.showFeedback(message, type, duration);
            } else {
                console.warn("commonUi.showFeedback não disponível. Exibindo alerta.");
                alert(message);
            }
        }
        
        async function apiFetch(endpoint, options = {}) {
            if (window.commonUi && window.commonUi.apiFetch) {
                return window.commonUi.apiFetch(endpoint, options);
            } else {
                console.error("commonUi.apiFetch não disponível.");
                throw new Error("API Fetch service not available.");
            }
        }


        function limparCamposEndereco() {
            if (logradouroInput) logradouroInput.value = "";
            if (bairroInput) bairroInput.value = "";
            if (cidadeInput) cidadeInput.value = "";
            if (estadoInput) estadoInput.value = "";
            if (numeroInput) numeroInput.value = "";
            if (complementoInput) complementoInput.value = "";
            if (cepStatusSpan) cepStatusSpan.textContent = "";
            if (cepStatusSpan) cepStatusSpan.className = "hidden"; // Esconde o status
        }

        async function buscarEnderecoPorCEP(cepValue) {
            if (!cepValue) return;
            if (cepStatusSpan) { cepStatusSpan.textContent = "Buscando..."; cepStatusSpan.className = "text-blue-600"; }
            limparCamposEndereco();

            try {
                const response = await fetch(`https://viacep.com.br/ws/${cepValue}/json/`);
                if (!response.ok) {
                    if (response.status === 400) throw new Error("Formato de CEP inválido.");
                    if (response.status === 404) throw new Error("CEP não encontrado.");
                    throw new Error("Falha na consulta.");
                }
                const data = await response.json();
                if (data.erro) { throw new Error("CEP não encontrado."); }

                if (logradouroInput) logradouroInput.value = data.logradouro || "";
                if (bairroInput) bairroInput.value = data.bairro || "";
                if (cidadeInput) cidadeInput.value = data.localidade || "";
                if (estadoInput) estadoInput.value = data.uf || "";

                if (cepStatusSpan) { showFeedback("Endereço encontrado!", 'success', 2000); }
                numeroInput?.focus();
            }
            catch (error) {
                console.error("Erro ao buscar CEP:", error);
                if (cepStatusSpan) { showFeedback(`Erro ao buscar CEP: ${error.message}`, 'error'); }
                limparCamposEndereco();
                cepInput?.focus();
            }
        }

        // Função para preencher o formulário com dados de uma empresa
        function fillFormWithCompanyData(company) {
            document.getElementById('razao-social').value = company.razaoSocial || '';
            document.getElementById('cnpj').value = company.cnpj || '';
            document.getElementById('nome-fantasia').value = company.nomeFantasia || '';
            document.getElementById('inscricao-estadual').value = company.inscricaoEstadual || '';
            document.getElementById('inscricao-municipal').value = company.inscricaoMunicipal || '';
            document.getElementById('telefone').value = company.telefone || '';
            document.getElementById('email').value = company.email || '';
            document.getElementById('responsavel-legal').value = company.responsavelLegal || '';

            document.getElementById('logradouro').value = company.addressStreet || '';
            document.getElementById('numero').value = company.addressNumber || '';
            document.getElementById('complemento').value = company.addressComplement || '';
            document.getElementById('bairro').value = company.neighborhood || '';
            document.getElementById('cidade').value = company.city || '';
            document.getElementById('estado').value = company.state || '';
            document.getElementById('cep').value = company.cep || '';
            if (company.cep) buscarEnderecoPorCEP(company.cep);
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            showFeedback('Enviando dados...', 'info');

            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            for (const key in data) {
                if (data[key] === '') {
                    data[key] = null;
                }
            }

            const companyData = {
                razaoSocial: data['razao_social'],
                cnpj: data['cnpj'],
                nomeFantasia: data['nome_fantasia'],
                inscricaoEstadual: data['inscricao_estadual'],
                inscricaoMunicipal: data['inscricao_municipal'],
                addressStreet: data['address_street'],
                addressNumber: data['address_number'],
                addressComplement: data['address_complement'],
                cep: data['cep'],
                city: data['city'],
                state: data['state'],
                neighborhood: data['neighborhood'],
                telefone: data['telefone'],
                email: data['email'],
                responsavelLegal: data['responsavel_legal'],
            };

            try {
                let url = '/api/companies'; // API para empresas
                let method = 'POST';

                if (currentCompanyId) { // Se estiver em modo de edição
                    url = `/api/companies?id=${currentCompanyId}`;
                    method = 'PUT';
                }

                const result = await apiFetch(url, { // Usa commonUi.apiFetch
                    method: method,
                    body: JSON.stringify(companyData),
                });

                if (result) {
                    showFeedback(`Empresa ${currentCompanyId ? 'atualizada' : 'cadastrada'} com sucesso!`, 'success');
                    console.log(`Empresa ${currentCompanyId ? 'atualizada' : 'cadastrada'}:`, result.company);
                    if (!currentCompanyId) {
                        form.reset();
                        limparCamposEndereco();
                    }
                } else {
                    showFeedback(`Erro ao ${currentCompanyId ? 'atualizar' : 'cadastrar'}: ${result.error || 'Erro desconhecido.'}`, 'error');
                    console.error('Erro na API:', result);
                }
            } catch (error) {
                // Erro já tratado por apiFetch
                console.error('Erro na requisição fetch (handleFormSubmit):', error);
            }
        }

        async function loadCompanyDataForEdit() {
            const urlParams = new URLSearchParams(window.location.search);
            const companyId = urlParams.get('id');

            if (companyId) {
                currentCompanyId = companyId;
                document.querySelector('h1').textContent = 'Editar Empresa';
                showFeedback(`Carregando dados para edição da empresa com ID: ${companyId}...`, 'info');

                try {
                    const result = await apiFetch(`/api/companies?id=${companyId}`, { // Reutiliza API GET /api/companies com filtro por ID
                        method: 'GET',
                    });

                    if (result && result.companies && result.companies.length > 0) {
                        fillFormWithCompanyData(result.companies[0]);
                        showFeedback('Dados da empresa carregados com sucesso!', 'success');
                    } else {
                        showFeedback('Empresa não encontrada.', 'error');
                        console.error('Empresa não encontrada:', result);
                    }
                } catch (error) {
                    // Erro já tratado por apiFetch
                    console.error('Erro na requisição fetch para carregar empresa:', error);
                }
            } else {
                document.querySelector('h1').textContent = 'Cadastro de Empresa';
                currentCompanyId = null;
            }
        }

        function handleFormReset() {
            limparCamposEndereco();
            showFeedback('Formulário limpo.', 'info');
            currentCompanyId = null;
            document.querySelector('h1').textContent = 'Cadastro de Empresa';
        }

        // --- CARREGAMENTO DOS COMPONENTES REUTILIZÁVEIS ---
        async function loadReusableComponents() {
            if (document.getElementById('header-placeholder')) {
                try {
                    const headerResponse = await fetch('includes/header.html');
                    document.getElementById('header-placeholder').innerHTML = await headerResponse.text();
                } catch (error) {
                    console.error("Erro ao carregar header.html:", error);
                    document.getElementById('header-placeholder').innerHTML = "<header class='page-header'><h1 class='text-red-500'>Erro ao carregar cabeçalho</h1></header>";
                }
            }
            if (document.getElementById('sidebar-placeholder')) {
                try {
                    const sidebarResponse = await fetch('includes/sidebar.html');
                    document.getElementById('sidebar-placeholder').innerHTML = await sidebarResponse.text();
                } catch (error) {
                    console.error("Erro ao carregar sidebar.html:", error);
                    document.getElementById('sidebar-placeholder').innerHTML = "<nav class='sidebar bg-red-100 text-red-700 p-4'>Erro ao carregar menu lateral</nav>";
                }
            }
            // Uma vez que os componentes são carregados, suas funcionalidades do common_ui.js serão inicializadas
            // common_ui.js já tem seu próprio DOMContentLoaded listener.
        }

        // --- Event Listeners e Inicialização ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Carrega os componentes reutilizáveis primeiro
            await loadReusableComponents();

            // Verifica autenticação (usando a função do common_ui)
            if (!window.commonUi || !window.commonUi.checkAuth || !window.commonUi.checkAuth()) {
                return; 
            }
            
            // Aqui você pode adicionar lógica específica para o back-link desta página
            const backLink = document.querySelector('.back-link');
            if (backLink) {
                backLink.href = 'dashboard.html'; // Ou para uma página de listagem de empresas, se existir
                backLink.classList.remove('hidden'); // Mostra o botão de voltar
            }


            cadastroEmpresaForm?.addEventListener('submit', handleFormSubmit);
            cadastroEmpresaForm?.addEventListener('reset', handleFormReset);

            buscarCepBtn?.addEventListener('click', () => {
                const cepValue = cepInput?.value.replace(/\D/g, "");
                if (cepValue && cepValue.length === 8) {
                    buscarEnderecoPorCEP(cepValue);
                } else {
                    showFeedback("CEP inválido. Digite 8 dígitos.", 'error');
                    limparCamposEndereco();
                }
            });

            cepInput?.addEventListener('input', () => {
                const cepValue = cepInput.value.replace(/\D/g, "");
                clearTimeout(cepTimeout);
                if (cepStatusSpan) { cepStatusSpan.textContent = ""; cepStatusSpan.className = "hidden"; }
                if (cepValue.length === 8) {
                    cepTimeout = setTimeout(() => { buscarEnderecoPorCEP(cepValue); }, 500);
                }
            });

            loadCompanyDataForEdit(); // Verifica se é modo de edição
            console.log("Página de Cadastro de Empresas inicializada.");
        });
    </script>
</body>
</html>
