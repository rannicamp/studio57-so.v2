<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Funcionário - Sistema Studio 57</title>
    <!-- CORREÇÃO AQUI: URLs COMPLETAS E CORRETAS PARA CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" xintegrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- FIM CORREÇÃO CDN -->
    <link rel="stylesheet" href="css/global.css"> <!-- LINK PARA CSS GLOBAL -->

    <style>
        /* Estilos ESPECÍFICOS DOS DETALHES DO FUNCIONÁRIO que NÃO estão no global.css */
        .employee-details-layout { display: flex; flex-wrap: wrap; gap: 1.5rem; margin-bottom: 1.5rem; }
        .employee-details-photo { flex-shrink: 0; width: 180px; height: 180px; border-radius: 50%; background-color: var(--color-medium-light-gray); display: flex; align-items: center; justify-content: center; color: var(--color-white); font-size: 4em; overflow: hidden; margin-bottom: 0.5rem; }
        .employee-details-info { flex-grow: 1; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem 1.5rem; }
        .info-item { margin-bottom: 0.5rem; }
        .info-item strong { display: block; font-size: 0.9em; color: var(--color-dark-gray); margin-bottom: 2px; }
        .info-item span { display: block; font-size: 1.1em; color: var(--color-dark); }
        .info-item.full-width { grid-column: 1 / -1; }
        .employee-actions-area { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--color-border); justify-content: center; }
        .employee-actions-area .btn { flex-grow: 1; min-width: 180px; padding: 0.75rem 1.5rem; }
    </style>
</head>
<body>
    <!-- HEADER SERÁ CARREGADO AQUI VIA JS -->
    <div id="header-placeholder"></div>

    <div class="page-wrapper">
        <!-- SIDEBAR SERÁ CARREGADA AQUI VIA JS -->
        <div id="sidebar-placeholder"></div>

        <main class="main-content" id="main-content-area">
            <div id="feedback" class="hidden"></div>

            <section class="section">
                <h2>Detalhes do Funcionário</h2>
                <div class="employee-details-layout">
                    <div class="employee-details-photo" id="employee-photo-initials">?</div>
                    <div class="employee-details-info">
                        <div class="info-item">
                            <strong>Nome Completo:</strong>
                            <span id="full-name-display">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <strong>CPF:</strong>
                            <span id="cpf-display">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <strong>RG:</strong>
                            <span id="rg-display">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <strong>Data de Nascimento:</strong>
                            <span id="birth-date-display">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <strong>Telefone:</strong>
                            <span id="phone-display">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <strong>Email:</strong>
                            <span id="email-display">Carregando...</span>
                        </div>
                        <div class="info-item full-width">
                            <strong>Logradouro:</strong>
                            <span id="address-street-display">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <strong>Número:</strong>
                            <span id="address-number-display">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <strong>Complemento:</strong>
                            <span id="address-complement-display">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <strong>CEP:</strong>
                            <span id="cep-display">Carregando...</span>
                        </div>
                         <div class="info-item">
                            <strong>Bairro:</strong>
                            <span id="neighborhood-display">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <strong>Cidade:</strong>
                            <span id="city-display">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <strong>Estado (UF):</strong>
                            <span id="state-display">Carregando...</span>
                        </div>

                        <div class="info-item full-width">
                            <strong>Empresa Contratante:</strong>
                            <span id="empresa-contratante-display">Carregando...</span>
                        </div>
                        <div class="info-item full-width">
                            <strong>Empreendimento Alocado:</strong>
                            <span id="empreendimento-alocado-display">Carregando...</span>
                        </div>

                        <div class="info-item">
                            <strong>Cargo / Função:</strong>
                            <span id="contract-role-display">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <strong>Data de Admissão:</strong>
                            <span id="admission-date-display">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <strong>Salário Base (R$):</strong>
                            <span id="base-salary-display">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <strong>Salário Total (R$):</strong>
                            <span id="total-salary-display">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <strong>Valor Dia (R$):</strong>
                            <span id="daily-value-display">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <strong>Forma de Pagamento:</strong>
                            <span id="payment-method-display">Carregando...</span>
                        </div>
                        <div class="info-item" id="pix-key-item" style="display: none;">
                            <strong>Chave PIX:</strong>
                            <span id="pix-key-display">Carregando...</span>
                        </div>
                        <div class="info-item full-width" id="bank-details-item" style="display: none;">
                            <strong>Dados Bancários:</strong>
                            <span id="bank-details-display">Carregando...</span>
                        </div>
                         <div class="info-item full-width">
                            <strong>Observações:</strong>
                            <span id="observations-display">Carregando...</span>
                        </div>
                        <div class="info-item full-width">
                            <strong>ASO:</strong>
                            <span id="aso-doc-display"></span>
                        </div>
                        <div class="info-item full-width">
                            <strong>Contrato de Trabalho:</strong>
                            <span id="contract-doc-display"></span>
                        </div>
                        <div class="info-item full-width">
                            <strong>Documento Identidade:</strong>
                            <span id="identity-doc-display"></span>
                        </div>
                    </div>
                </section>

                <div class="employee-actions-area">
                    <a href="#" id="edit-employee-btn" class="btn btn-primary"><i class="fas fa-edit"></i> Editar Cadastro</a>
                    <button type="button" id="delete-employee-btn" class="btn btn-danger"><i class="fas fa-trash-alt"></i> Excluir Funcionário</button>
                    <a href="#" id="view-timesheet-btn" class="btn btn-secondary"><i class="fas fa-clock"></i> Ver Folha de Ponto</a>
                </div>

            </main>
        </div>
        <script src="js/common_ui.js"></script> <!-- LINK PARA JS COMUM -->
        <script>
            // --- Seletores Globais (adaptados para common_ui.js) ---
            const employeePhotoInitials = document.getElementById('employee-photo-initials');
            const editEmployeeBtn = document.getElementById('edit-employee-btn');
            const deleteEmployeeBtn = document.getElementById('delete-employee-btn');
            const viewTimesheetBtn = document.getElementById('view-timesheet-btn');

            const empresaContratanteDisplay = document.getElementById('empresa-contratante-display');
            const empreendimentoAlocadoDisplay = document.getElementById('empreendimento-alocado-display');

            let currentEmployeeId = null;

            // --- Funções Auxiliares (adaptadas para common_ui.js) ---
            function displayEmployeeDetails(employee) {
                document.getElementById('full-name-display').textContent = employee.fullName || 'Não informado';
                employeePhotoInitials.textContent = employee.fullName ? employee.fullName.split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase() : '?';

                document.getElementById('cpf-display').textContent = employee.cpf || 'Não informado';
                document.getElementById('rg-display').textContent = employee.rg || 'Não informado';
                document.getElementById('birth-date-display').textContent = employee.birthDate ? new Date(employee.birthDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'Não informado';
                document.getElementById('phone-display').textContent = employee.phone || 'Não informado';
                document.getElementById('email-display').textContent = employee.email || 'Não informado';

                document.getElementById('address-street-display').textContent = employee.addressStreet || 'Não informado';
                document.getElementById('address-number-display').textContent = employee.addressNumber || 'Não informado';
                document.getElementById('address-complement-display').textContent = employee.addressComplement || 'Não informado';
                
                document.getElementById('cep-display').textContent = employee.cep || 'Não informado';
                document.getElementById('neighborhood-display').textContent = employee.neighborhood || 'Não informado';
                document.getElementById('city-display').textContent = employee.city || 'Não informado';
                document.getElementById('state-display').textContent = employee.state || 'Não informado';

                empresaContratanteDisplay.textContent = employee.empresaContratanteNome || 'Não informado';
                empreendimentoAlocadoDisplay.textContent = employee.empreendimentoAlocadoNome || 'Não informado';

                document.getElementById('contract-role-display').textContent = employee.contractRole || 'Não informado';
                document.getElementById('admission-date-display').textContent = employee.admissionDate ? new Date(employee.admissionDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'Não informado';
                document.getElementById('base-salary-display').textContent = employee.baseSalary ? parseFloat(employee.baseSalary).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'Não informado';
                document.getElementById('total-salary-display').textContent = employee.totalSalary ? parseFloat(employee.totalSalary).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'Não informado';
                document.getElementById('daily-value-display').textContent = employee.dailyValue ? parseFloat(employee.dailyValue).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'Não informado';

                document.getElementById('payment-method-display').textContent = employee.paymentMethod || 'Não informado';

                const pixKeyItem = document.getElementById('pix-key-item');
                const bankDetailsItem = document.getElementById('bank-details-item');

                if (employee.paymentMethod === 'pix') {
                    pixKeyItem.style.display = 'block';
                    document.getElementById('pix-key-display').textContent = employee.pixKey || 'Não informado';
                    bankDetailsItem.style.display = 'none';
                } else if (employee.paymentMethod === 'deposito') {
                    bankDetailsItem.style.display = 'block';
                    document.getElementById('bank-details-display').textContent = employee.bankDetails || 'Não informado';
                    pixKeyItem.style.display = 'none';
                } else {
                    pixKeyItem.style.display = 'none';
                    bankDetailsItem.style.display = 'none';
                }

                document.getElementById('aso-doc-display').innerHTML = employee.asoDoc ? `<a href="${employee.asoDoc}" target="_blank">Ver ASO (${employee.asoDoc})</a>` : 'Nenhum';
                document.getElementById('contract-doc-display').innerHTML = employee.contractDoc ? `<a href="${employee.contractDoc}" target="_blank">Ver Contrato (${employee.contractDoc})</a>` : 'Nenhum';
                document.getElementById('identity-doc-display').innerHTML = employee.identityDoc ? `<a href="${employee.identityDoc}" target="_blank">Ver Identidade (${employee.identityDoc})</a>` : 'Nenhum';
                
                document.getElementById('observations-display').textContent = employee.observations || 'Nenhuma';

                editEmployeeBtn.href = `registro_funcionario.html?id=${employee.id}`;
                viewTimesheetBtn.href = `folha de ponto.html?employeeId=${employee.id}`;
            }

            async function loadEmployeeDetails() {
                const urlParams = new URLSearchParams(window.location.search);
                const employeeId = urlParams.get('id');

                if (!employeeId) {
                    window.commonUi.showFeedback('ID do funcionário não fornecido na URL.', 'error');
                    document.querySelector('h1').textContent = 'Erro';
                    return;
                }

                currentEmployeeId = employeeId;
                window.commonUi.showFeedback(`Carregando detalhes do funcionário com ID: ${employeeId}...`, 'info');

                try {
                    const result = await window.commonUi.apiFetch(`/api/get-employee-by-id?id=${employeeId}`, {
                        method: 'GET',
                    });

                    if (result && result.employee) {
                        displayEmployeeDetails(result.employee);
                        window.commonUi.showFeedback('Detalhes do funcionário carregados com sucesso!', 'success');
                        document.querySelector('h1').textContent = `Detalhes de ${result.employee.fullName}`;
                    } else {
                        window.commonUi.showFeedback('Funcionário não encontrado.', 'error');
                        console.error('Funcionário não encontrado:', result);
                        document.querySelector('h1').textContent = 'Funcionário Não Encontrado';
                    }
                } catch (error) {
                    console.error('Erro na requisição fetch para carregar funcionário:', error);
                    document.querySelector('h1').textContent = 'Erro de Conexão';
                }
            }

            async function deleteEmployee() {
                if (!currentEmployeeId) {
                    alert('Nenhum funcionário selecionado para exclusão.');
                    return;
                }

                if (confirm(`Tem certeza que deseja EXCLUIR o funcionário ID ${currentEmployeeId} (${document.getElementById('full-name-display').textContent})? Esta ação é irreversível.`)) {
                    window.commonUi.showFeedback('Excluindo funcionário...', 'info');
                    try {
                        const result = await window.commonUi.apiFetch(`/api/delete-employee?id=${currentEmployeeId}`, {
                            method: 'DELETE',
                        });

                        if (result && result.deletedId) {
                            window.commonUi.showFeedback('Funcionário excluído com sucesso!', 'success');
                            console.log(`Funcionário ID ${currentEmployeeId} excluído.`);
                            setTimeout(() => {
                                window.location.href = 'quadrodefuncionarios.html';
                            }, 1500);
                        } else {
                            window.commonUi.showFeedback(`Erro ao excluir: ${result.error || 'Erro desconhecido.'}`, 'error');
                        }
                    } catch (error) {
                        console.error('Erro na requisição fetch para exclusão:', error);
                    }
                }
            }

            document.addEventListener('DOMContentLoaded', async () => {
                // common_ui.js já cuida do carregamento de header/sidebar, data/hora e user info.
                // E também da verificação de autenticação.
                if (!window.commonUi || !window.commonUi.checkAuth || !window.commonUi.checkAuth()) {
                    return; 
                }

                const backLink = document.querySelector('.back-link');
                if (backLink) {
                    backLink.href = 'quadrodefuncionarios.html';
                    backLink.classList.remove('hidden');
                }

                await loadEmployeeDetails(); // Carrega os detalhes do funcionário

                deleteEmployeeBtn.addEventListener('click', deleteEmployee);
            });
        </script>
    </body>
    </html>
